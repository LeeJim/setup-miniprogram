"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.getCompiledResult=exports.SIGNATURE_FILE_NAME=void 0;const tslib_1=require("tslib"),fs_extra_1=(0,tslib_1.__importDefault)(require("fs-extra")),compile_1=require("../core/compile"),config_1=require("../config"),error_1=require("../utils/error"),locales_1=(0,tslib_1.__importDefault)(require("../utils/locales/locales")),cache_1=require("../utils/cache"),jszip_1=(0,tslib_1.__importDefault)(require("jszip")),path_1=(0,tslib_1.__importDefault)(require("path"));async function getCompiledResult(e,t){const{project:r,setting:o={},version:i="",onProgressUpdate:s=function(e){console.log(""+e)},threads:a=0,includedMap:l=!1}=e;if(process.env.COMPILE_THREADS=a.toString(),!i)throw new error_1.CodeError(locales_1.default.config.PARAM_ERROR.format("upload","version"),config_1.PARAM_ERROR);if(!r)throw new error_1.CodeError(locales_1.default.config.PARAM_ERROR.format("upload","project"),config_1.PARAM_ERROR);cache_1.cacheManager.clean();const _=await(0,compile_1.compile)(r,{setting:o,onProgressUpdate:s}),c={};if(Object.keys(_).sort().forEach(e=>{e.endsWith("js.map")&&!l||(c[e]=_[e])}),t){const e=new jszip_1.default;Object.keys(c).forEach(t=>{e.folder(path_1.default.dirname(t)).file(path_1.default.basename(t),c[t])});const r=await e.generateAsync({type:"nodebuffer"});fs_extra_1.default.ensureDirSync(path_1.default.dirname(t)),fs_extra_1.default.writeFileSync(t,r)}return c}exports.SIGNATURE_FILE_NAME="ci.signature",exports.getCompiledResult=getCompiledResult;