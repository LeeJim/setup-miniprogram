"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.glob=void 0;const tslib_1=require("tslib"),path_1=(0,tslib_1.__importDefault)(require("path")),minimatch_1=require("minimatch"),fs_1=(0,tslib_1.__importDefault)(require("./fs")),tools_1=require("./tools"),log_1=(0,tslib_1.__importDefault)(require("./log"));function ignoreMap(t){let e=null;if("/**"===t.slice(-3)){const r=t.replace(/(\/\*\*)+$/,"");e=new minimatch_1.Minimatch(r,{dot:!0})}return{matcher:new minimatch_1.Minimatch(t,{dot:!0}),gmatcher:e}}async function readdir(t,e){const{ignore:r,cwd:i}=e;return(await fs_1.default.readdir(path_1.default.posix.join(i,t))).filter(e=>{const i=(0,tools_1.normalizePath)(path_1.default.posix.join(t,e)),o=isIgnored(i,r);return o&&log_1.default.debug(`file '${i}' has been ignore`),!o})}function childrenIgnored(t,e){return!!e.length&&e.some(e=>{var r;return!!(null===(r=e.gmatcher)||void 0===r?void 0:r.match(t))})}function isIgnored(t,e){return!!e.length&&e.some(e=>{var r;return e.matcher.match(t)||!!(null===(r=e.gmatcher)||void 0===r?void 0:r.match(t))})}async function _glob(t,e){const{cwd:r,ignore:i,dir:o}=e,n=path_1.default.posix.join(r,t),a=await fs_1.default.stat(n);if(!a)return[];if(a.isFile())return[(0,tools_1.normalizePath)(t)];if(a.isDirectory()){if(childrenIgnored(t,i))return log_1.default.debug(`directory '${n}' has been ignore`),[];let r=[];o&&t&&r.push((0,tools_1.normalizePath)(t+"/"));const a=await readdir(t,e);for(const i of a){const o=await _glob(path_1.default.posix.join(t,i),e);r=r.concat(o)}return r}return[]}async function glob(t){const{cwd:e,ignore:r,dir:i=!1}=t;let o=[];return Array.isArray(r)&&(o=r.map(ignoreMap)),_glob("",{cwd:e,ignore:o,dir:i})}exports.glob=glob;